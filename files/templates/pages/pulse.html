{% extends 'layout/layout.html' %}

{% block content %}
<div class="video-feed-container">
    <div class="video-feed">
        {% for pulse in pulses %}
        <div class="video">
            <video class="video-player" controls>
                <source src="{{ pulse.video.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="play-button" onclick="togglePlayPause(this)">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8 5v14l11-7z"/>
                </svg>
            </div>
            <div class="video-info">
                {% if pulse.artist.rank == 'admin' %}
                <p style="color: red;">
                    <strong><a style="color: red;" href="{% url 'accounts:profile' pulse.artist.username %}">{{ pulse.artist }}</a></strong>
                </p>
                {% elif pulse.artist.rank == 'diamond' %}
                <p style=" color: rgb(50, 110, 187);">
                    <strong><a style=" color: rgb(50, 110, 187);" href="{% url 'accounts:profile' pulse.artist.username %}">{{ pulse.artist }}</a></strong>
                </p>
                {% else %}
                <p>
                    <strong><a style=" color: rgb(255, 255, 255);" href="{% url 'accounts:profile' pulse.artist.username %}">{{ pulse.artist }}</a></strong>
                </p>
                {% endif %}
                <h5><strong>{{ pulse.title }}</strong></h5>
                <p>{{ pulse.description }}</p>
            </div>
            <a href="{% url 'pulse:upload_pulse' %}" class="navbar-top-item"  style="color: rgb(255, 255, 255); padding: 7px 0px; position:absolute; top:20px; left:-180px;">Upload one ??</a>
            <div class="video-button">
                
                <form method="POST">
                    {% csrf_token %}
                    {% if request.user.is_authenticated %}
                    <input type="hidden" name="pulse_id" value="{{ pulse.id }}">
                    <button type="submit" class="like-button">
                        {% if request.user in pulse.likes.all %}
                        <i class="fa-solid fa-heart fa-xl" style="color: #c03535;"></i>
                        {% else %}
                        <i class="fa-regular fa-heart fa-xl" style="color: #f8f8f8;"></i>
                        {% endif %}
                        <span class="like-count" style="color: #fff; margin-top:20px;">{{ pulse.like_count }}</span>
                    </button>
                    {% else %}
                    <div class="like-button">
                        <i class="fa-regular fa-heart fa-xl" style="color: #f8f8f8;"></i>
                        <span class="like-count" style="color: #fff; margin-top:20px;">{{ pulse.like_count }}</span>
                    </div>
                    {% endif %}
                </form>
            </div>
            <form id="view-form-{{ pulse.id }}" method="POST" style="display: none;">
                {% csrf_token %}
                <input type="hidden" name="pulse_id" value="{{ pulse.id }}">
            </form>
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // JavaScript for video feed navigation
    let currentVideo = null;

    document.addEventListener('keydown', function(event) {
        if (event.key === 'ArrowUp') {
            event.preventDefault(); // Prevent default scrolling behavior
            scrollVideo('prev');
        } else if (event.key === 'ArrowDown') {
            event.preventDefault(); // Prevent default scrolling behavior
            scrollVideo('next');
        }
    });

    // Disable mouse wheel scrolling
    document.addEventListener('wheel', function(event) {
        event.preventDefault();
    }, { passive: false });

    function scrollVideo(direction) {
        const videos = document.querySelectorAll('.video');
        const videoPlayers = document.querySelectorAll('.video-player');

        let currentIndex = -1;
        videoPlayers.forEach((player, index) => {
            if (!player.paused) {
                currentIndex = index;
            }
        });

        if (currentIndex !== -1) {
            videoPlayers[currentIndex].pause();
        }

        if (direction === 'prev') {
            if (currentIndex > 0) {
                videos[currentIndex -1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                videoPlayers[currentIndex - 1].play();
                currentVideo = videoPlayers[currentIndex - 1];
            }
        } else if (direction === 'next') {
            if (currentIndex < videos.length - 1) {
                videos[currentIndex +1].scrollIntoView({ behavior: 'smooth', block: 'start' });
                videoPlayers[currentIndex + 1].play();
                currentVideo = videoPlayers[currentIndex + 1];
            }
        }
    }

    function togglePlayPause(button) {
        const videoContainer = button.closest('.video');
        const videoPlayer = videoContainer.querySelector('.video-player');

        if (videoPlayer.paused) {
            videoPlayer.play();
            button.style.display = 'none'; // Hide play button when playing
        } else {
            videoPlayer.pause();
            button.style.display = 'flex'; // Show play button when paused
        }
    }

    // view count increment 
    document.querySelectorAll('.video-player').forEach(player => {
        player.addEventListener('play', async function(event) {
            const pulseId = this.closest('.video').querySelector('[name="pulse_id"]').value;
            const form = document.getElementById(`view-form-${pulseId}`);
            const formData = new FormData(form);
            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                });
                if (!response.ok) {
                    throw new Error('Failed to increment view count');
                }
                const data = await response.json();
                if (data.status === 'success') {
                    const pulseViewCount = document.querySelector(`#pulse-view-count-${pulseId}`);
                    pulseViewCount.textContent = parseInt(pulseViewCount.textContent) + 1;
                } else {
                    console.error(data.message);
                }
            } catch (error) {
                console.error('Error:', error.message);
            }
        });
    });
</script>

{% endblock content %}
